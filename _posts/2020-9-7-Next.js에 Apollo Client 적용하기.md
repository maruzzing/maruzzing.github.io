---
layout: post
title: Next.jsì— Apollo Client ì ìš©í•˜ê¸°
date: 2020-09-09
comments: true
categories: [Study, nextjs, graphql]
tags: [Next.js, Typescript, Apollo, GraphQL]
excerpt: ê¸°ë³¸ì ì¸ ì›¹ êµ¬ì¶•ì´ ë˜ì—ˆìœ¼ë‹ˆ GraphQLì„ ì ìš©í•´ ë³¼ ì°¨ë¡€ì´ë‹¤. ì´ë¥¼ ìœ„í•´ Apolloë¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•  ê±´ë°, GraphQL API ì½œì„ ë„ì™€ì¤„ ë¿ë§Œ ì•„ë‹ˆë¼ ìºì‹±ê³¼ ìƒíƒœê´€ë¦¬ ë“± ë‹¤ì–‘í•œ ì´ì ì´ ìˆì–´ ğŸš€ Apollo Clientë¥¼ ì ìš©í•´ ë³´ê¸°ë¡œ í–ˆë‹¤. 
---

ê¸°ë³¸ì ì¸ ì›¹ êµ¬ì¶•ì´ ë˜ì—ˆìœ¼ë‹ˆ GraphQLì„ ì ìš©í•´ ë³¼ ì°¨ë¡€ì´ë‹¤. ì´ë¥¼ ìœ„í•´ Apolloë¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•  ê±´ë°, GraphQL API ì½œì„ ë„ì™€ì¤„ ë¿ë§Œ ì•„ë‹ˆë¼ ìºì‹±ê³¼ ìƒíƒœê´€ë¦¬ ë“± ë‹¤ì–‘í•œ ì´ì ì´ ìˆì–´ ğŸš€ Apollo Clientë¥¼ ì ìš©í•´ ë³´ê¸°ë¡œ í–ˆë‹¤. 

## ëª¨ë“ˆ ì„¤ì¹˜

Apollo Clientë¥¼ êµ¬ì¶•í•˜ëŠ”ë° í•„ìš”í•œ ê±°ì˜ ëª¨ë“  ê¸°ëŠ¥ì„ ê°€ì§€ê³  ìˆëŠ” [@apollo/client](https://github.com/apollographql/apollo-client)ì™€ GraphQL ì¿¼ë¦¬ë¥¼ íŒŒì‹±í•´ì£¼ëŠ” [graphql](https://github.com/graphql/graphql-js)ì„ ì„¤ì¹˜í•œë‹¤.

```bash
$ npm i @apollo/client graphql
```

## Apollo Client ìƒì„±í•˜ê¸°

ë¨¼ì €, /src/lib í´ë” ë‚´ì— `apolloClient.ts` íŒŒì¼ì„ ìƒì„±í•˜ê³ , ApolloClient ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•œë‹¤. ì´ ë•Œ GraphQL ì„œë²„ urlì´ í•„ìš”í•˜ë‹¤.  `.env` íŒŒì¼ì— `BACKEND_URL`ì„ ì •ì˜í•˜ê³  ì•„ë˜ì™€ ê°™ì´ ì ìš©í–ˆë‹¤. 

```javascript
import { ApolloClient, InMemoryCache } from '@apollo/client';

const client = new ApolloClient({
  uri: process.env.BACKEND_URL,
  cache: new InMemoryCache()
});
```

## Apollo Client ì—°ê²°í•˜ê¸°

í”„ë¡œì íŠ¸ ì „ì—­ì—ì„œ  ApolloClientì— ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ í•˜ê¸° ìœ„í•´ `_app.tsx`ì— ì ìš©í•´ ì£¼ê² ë‹¤. ì´ì „ í¬ìŠ¤íŒ…ì—ì„œ ë§Œë“¤ì—ˆë˜ `_app.tsx`ì˜ ìµœìƒìœ„ ì»´í¬ë„ŒíŠ¸ë¥¼ `ApolloProvider`ë¡œ ê°ì‹¸ê³  ì´ì „ì— ë§Œë“¤ì—ˆë˜ `client`ë¥¼ `props`ë¡œ ë„˜ê²¨ ì£¼ë©´ ëœë‹¤.

```javascript
...
import {ApolloProvider} from '@apollo/client';
import {client} from '../src/lib/apolloClient';
...


export default function App({Component, pageProps}: AppProps) {

  return (
    <ApolloProvider client={client}>
      <ThemeProvider theme={theme}>
          <GlobalStyle />
          <Component {...pageProps} />
      </ThemeProvider>
    </ApolloProvider>
  );
}
``` 

## GraphQL API í˜¸ì¶œí•˜ê¸°

ì´ì œ ê°„ë‹¨í•œ GraphQL APIë¥¼ í˜¸ì¶œí•´ ë³´ì. ë¨¼ì € src/graphql/query í´ë”ë¥¼ ë§Œë“¤ê³  `index.ts` íŒŒì¼ì„ ìƒì„±í•œë‹¤. ìƒì„±í•œ íŒŒì¼ ë‚´ì— GraphQL ì¿¼ë¦¬ë¥¼ ì •ì˜ í•˜ëŠ”ë° template literal tagì¸ `gql`ì„ ì‚¬ìš©í•œë‹¤.

```javascript
import {gql} from '@apollo/client';
export const TEST_QUERY = gql`
  {
    ping
  }
`;
``` 

### useQuery ì‚¬ìš©í•˜ê¸°

@apollo/clientì—ì„œëŠ” `useQuery` ë¼ëŠ” ì•„ì£¼ ê°•ë ¥í•˜ê³  ê°„ë‹¨í•œ hooksë¥¼ ì œê³µí•œë‹¤.
`pages/index.tsx` íŒŒì¼ì„ ì•„ë˜ì™€ ê°™ì´ ìˆ˜ì •í•˜ë©´ GraphQL APIê°€ í˜¸ì¶œë˜ì–´ ì‘ë‹µê°’ì„ ë°›ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

```javascript
import Link from 'next/link'
import Layout from '../src/components/Layout'
import { useQuery } from '@apollo/client';
import {TEST_QUERY} from '../src/graphql/query';

const IndexPage = () => {
  const { loading, error, data } = useQuery(TEST_QUERY)
  console.log(loading, error, data)
  return (
    <Layout>
      <h1>Hello Next.js ğŸ‘‹</h1>
    </Layout>
  )
}
export default IndexPage
```
<br>
ì½˜ì†”ë¡œê·¸
<div style='display: flex; justify-content: left; margin-top:-1em'>
  <img src="/images/apollo-client.png" alt="apollo-client" width="400em">
</div>


### getStaticProps ì‚¬ìš©í•˜ê¸°

ì •ì /ì‚¬ì „ ë Œë”ë§ì´ í•„ìš”í•œ ê²½ìš°, next.jsì˜ `getStaticProps` ë‚´ì—ì„œë„ GraphQL API í˜¸ì¶œì´ ê°€ëŠ¥í•˜ë‹¤. 

```javascript
import Link from 'next/link'
import Layout from '../src/components/Layout'
import { useQuery } from '@apollo/client';
import {TEST_QUERY} from '../src/graphql/query';
import {client} from '../src/lib/apolloClient'

const IndexPage = (props:any) => {
  console.log(props) // =>  { ping: 'ğŸ‘‹ pong! ğŸ‘‹' }

  return (
    <Layout>
      <h1>Hello Next.js ğŸ‘‹</h1>
    </Layout>
  )
}
export default IndexPage

export const getStaticProps: GetStaticProps = async () => {
  const {data} = await client.query({
    query: TEST_QUERY,
  });
  return {
    props: data,
  };
};
```